<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firewall Dashboard - PBL4</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card-stats { border-left: 5px solid #0d6efd; }
        .status-active { color: green; font-weight: bold; }
        .status-stopped { color: red; font-weight: bold; }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-primary mb-4">
    <div class="container">
        <span class="navbar-brand mb-0 h1">üõ°Ô∏è H·ªá Th·ªëng Qu·∫£n L√Ω T∆∞·ªùng L·ª≠a</span>
        <a href="/logout" class="btn btn-sm btn-light">ƒêƒÉng xu·∫•t</a>
    </div>
</nav>

<div class="container">
    <!-- Status Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card card-stats shadow-sm">
                <div class="card-body">
                    <h5 class="card-title text-muted">IP ƒêang B·ªã Ch·∫∑n</h5>
                    <h2 id="blocked-count">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-stats shadow-sm" style="border-left-color: #dc3545;">
                <div class="card-body">
                    <h5 class="card-title text-muted">D·ªãch V·ª• Auto-Block</h5>
                    <h2 id="service-status">...</h2>
                    <button class="btn btn-sm btn-outline-dark" onclick="toggleService()">B·∫≠t/T·∫Øt</button>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-stats shadow-sm" style="border-left-color: #ffc107;">
                <div class="card-body">
                    <h5 class="card-title text-muted">C·∫≠p nh·∫≠t l√∫c</h5>
                    <h2 id="last-update">--:--:--</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Tabs -->
    <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#alerts">üö® C·∫£nh B√°o & Log</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#rules">üìú Rules IPTables</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#config">‚öôÔ∏è C·∫•u H√¨nh</button></li>
    </ul>

    <div class="tab-content" id="myTabContent">
        <!-- Tab Alerts -->
        <div class="tab-pane fade show active" id="alerts">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="input-group mb-3">
                        <input type="text" id="manual-ip" class="form-control" placeholder="Nh·∫≠p IP ƒë·ªÉ x·ª≠ l√Ω th·ªß c√¥ng...">
                        <button class="btn btn-danger" onclick="manualAction('block')">Ch·∫∑n Ngay</button>
                        <button class="btn btn-success" onclick="manualAction('unblock')">G·ª° Ch·∫∑n</button>
                    </div>
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Th·ªùi gian</th>
                                <th>IP Ngu·ªìn</th>
                                <th>H√†nh ƒë·ªông</th>
                                <th>L√Ω do</th>
                            </tr>
                        </thead>
                        <tbody id="alert-table-body">
                            <!-- D·ªØ li·ªáu s·∫Ω load ·ªü ƒë√¢y -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab Rules -->
        <div class="tab-pane fade" id="rules">
            <div class="card shadow-sm">
                <div class="card-body">
                    <button class="btn btn-secondary mb-2" onclick="loadRules()">L√†m m·ªõi Rules</button>
                    <pre id="iptables-rules" class="bg-dark text-white p-3 rounded">ƒêang t·∫£i...</pre>
                </div>
            </div>
        </div>

        <!-- Tab Config -->
        <div class="tab-pane fade" id="config">
            <div class="card shadow-sm">
                <div class="card-body">
                    <form id="config-form">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label>Ng∆∞·ª°ng SYN (g√≥i/ph√∫t)</label>
                                <input type="number" class="form-control" id="conf-syn">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label>Ng∆∞·ª°ng Connection</label>
                                <input type="number" class="form-control" id="conf-conn">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label>Th·ªùi gian ch·∫∑n (gi√¢y) - 0 l√† vƒ©nh vi·ªÖn</label>
                                <input type="number" class="form-control" id="conf-ban">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label>Whitelist (C√°c IP c√°ch nhau d·∫•u ph·∫©y)</label>
                                <input type="text" class="form-control" id="conf-white">
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="saveConfig()">L∆∞u C·∫•u H√¨nh</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- Utils ---
    async function apiCall(url, method='GET', body=null) {
        const opts = { method: method, headers: {'Content-Type': 'application/json'} };
        if (body) opts.body = JSON.stringify(body);
        const res = await fetch(url, opts);
        if (res.redirected) window.location.href = res.url;
        return res.json();
    }

    // --- Status Loop ---
    function updateStatus() {
        apiCall('/api/status').then(data => {
            document.getElementById('blocked-count').innerText = data.blocked_count;
            document.getElementById('last-update').innerText = data.updated_at;
            
            const srv = document.getElementById('service-status');
            srv.innerText = data.service_status;
            srv.className = data.service_status === 'ACTIVE' ? 'status-active' : 'status-stopped';

            // Update Alerts Table
            const tbody = document.getElementById('alert-table-body');
            tbody.innerHTML = '';
            data.alerts.forEach(alert => {
                const row = `<tr>
                    <td>${new Date(alert.timestamp * 1000).toLocaleString()}</td>
                    <td>${alert.ip}</td>
                    <td><span class="badge bg-${alert.action === 'BLOCKED' ? 'danger' : 'success'}">${alert.action}</span></td>
                    <td>${alert.reason}</td>
                </tr>`;
                tbody.innerHTML += row;
            });
        });
    }

    // --- Actions ---
    function manualAction(type) {
        const ip = document.getElementById('manual-ip').value;
        if (!ip) return alert('Vui l√≤ng nh·∫≠p IP');
        apiCall('/api/action', 'POST', {type: type, ip: ip}).then(res => {
            alert(res.message);
            updateStatus();
        });
    }

    function toggleService() {
        const current = document.getElementById('service-status').innerText;
        apiCall('/api/action', 'POST', {type: 'toggle_service', current_status: current}).then(res => {
            alert(res.message);
            setTimeout(updateStatus, 1000);
        });
    }

    function loadRules() {
        apiCall('/api/rules').then(data => {
            document.getElementById('iptables-rules').innerText = data.rules;
        });
    }

    // --- Config ---
    function loadConfig() {
        apiCall('/api/config').then(data => {
            if (!data) return;
            document.getElementById('conf-syn').value = data.syn_threshold || 50;
            document.getElementById('conf-conn').value = data.conn_threshold || 100;
            document.getElementById('conf-ban').value = data.ban_time || 0;
            document.getElementById('conf-white').value = (data.whitelist || []).join(', ');
        });
    }

    function saveConfig() {
        const config = {
            syn_threshold: parseInt(document.getElementById('conf-syn').value),
            conn_threshold: parseInt(document.getElementById('conf-conn').value),
            ban_time: parseInt(document.getElementById('conf-ban').value),
            check_interval: 10,
            whitelist: document.getElementById('conf-white').value.split(',').map(s => s.trim()).filter(s => s)
        };
        apiCall('/api/config', 'POST', config).then(res => alert(res.message));
    }

    // Init
    setInterval(updateStatus, 5000);
    updateStatus();
    loadRules();
    loadConfig();
</script>
</body>
</html>
